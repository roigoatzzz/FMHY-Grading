<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FMHY Stream Grading</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root {
            --glass-bg: rgba(13, 17, 23, 0.75);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-highlight: rgba(255, 255, 255, 0.03);
            --accent-color: #38bdf8;
            --text-main: #edf2f7;
            --text-muted: #94a3b8;
            --danger: #f87171;
            --success: #34d399;
        }

        * {
            box-sizing: border-box;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

        body {
            margin: 0;
            font-family: 'Outfit', sans-serif;
            background-color: #02040a;
            /* subtle gradient mesh background */
            background-image: 
                radial-gradient(at 0% 0%, rgba(56, 189, 248, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(139, 92, 246, 0.15) 0px, transparent 50%);
            background-attachment: fixed;
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        /* --- SIDEBAR --- */
        #sidebar {
            width: 280px;
            height: 100%;
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-right: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            z-index: 50;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .brand {
            padding: 25px 20px;
            font-size: 1.4rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            color: #fff;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Logo icon simulation */
        .brand::before {
            content: '';
            display: block;
            width: 12px;
            height: 12px;
            background: var(--accent-color);
            border-radius: 50%;
            box-shadow: 0 0 15px var(--accent-color);
        }

        #nav-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px 10px;
        }

        .nav-item {
            display: block;
            padding: 10px 14px;
            margin-bottom: 4px;
            color: var(--text-muted);
            text-decoration: none;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.2s;
            border: 1px solid transparent;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .nav-item:hover {
            background: var(--glass-highlight);
            color: #fff;
            border-color: var(--glass-border);
            transform: translateX(4px);
        }

        .nav-item.active {
            background: rgba(56, 189, 248, 0.1);
            color: var(--accent-color);
            border-color: rgba(56, 189, 248, 0.2);
        }

        .nav-item.sub-item {
            padding-left: 24px;
            font-size: 0.85rem;
            border-left: 2px solid rgba(255,255,255,0.05);
            border-radius: 0 8px 8px 0;
        }

        /* --- MAIN CONTENT --- */
        #main-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        header {
            padding: 15px 30px;
            background: rgba(2, 4, 10, 0.6);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 40;
        }

        .header-left { display: flex; align-items: center; gap: 15px; }

        .status-pill {
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 20px;
            background: rgba(255,255,255,0.05);
            color: var(--text-muted);
            border: 1px solid var(--glass-border);
        }

        #refreshBtn {
            background: var(--accent-color);
            color: #000;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.2);
        }

        #refreshBtn:hover {
            transform: translateY(-1px);
            box-shadow: 0 0 20px rgba(56, 189, 248, 0.4);
        }
        
        #refreshBtn:disabled {
            opacity: 0.6;
            cursor: wait;
            transform: none;
        }

        #content-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 40px 10%;
            scroll-behavior: smooth;
        }

        .markdown-body {
            max-width: 1000px;
            margin: 0 auto;
            line-height: 1.7;
        }

        /* Markdown Elements */
        .markdown-body h1, .markdown-body h2, .markdown-body h3 {
            color: #fff;
            margin-top: 2em;
            scroll-margin-top: 100px; /* fix scroll position */
        }

        .markdown-body h1 { 
            font-size: 2.5rem; 
            border-bottom: 1px solid var(--glass-border); 
            padding-bottom: 15px;
            background: linear-gradient(to right, #fff, #94a3b8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .markdown-body h1 img {
            max-width: 100%;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .markdown-body a { color: var(--accent-color); text-decoration: none; }
        .markdown-body a:hover { text-decoration: underline; }

        /* Tables */
        .markdown-body table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 25px 0;
            background: rgba(255,255,255,0.02);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            overflow: hidden;
            font-size: 0.95rem;
        }

        .markdown-body th {
            background: rgba(255,255,255,0.05);
            text-align: left;
            padding: 16px;
            font-weight: 600;
            color: var(--accent-color);
            border-bottom: 1px solid var(--glass-border);
        }

        .markdown-body td {
            padding: 16px;
            border-bottom: 1px solid var(--glass-border);
            color: #cbd5e1;
        }

        .markdown-body tr:last-child td { border-bottom: none; }
        .markdown-body tr:hover td { background: rgba(255,255,255,0.03); }

        /* Mobile Menu */
        #menu-toggle { display: none; background: none; border: none; color: #fff; font-size: 1.4rem; cursor: pointer; }

        @media (max-width: 900px) {
            #sidebar {
                position: fixed;
                left: 0; top: 0;
                transform: translateX(-100%);
                width: 85%;
                box-shadow: 50px 0 100px rgba(0,0,0,0.5);
            }
            #sidebar.open { transform: translateX(0); }
            #content-scroll { padding: 20px; }
            #menu-toggle { display: block; }
            .markdown-body table { display: block; overflow-x: auto; white-space: nowrap; }
        }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <nav id="sidebar">
        <div class="brand">FMHY Grading</div>
        <div id="nav-container">
            <div style="padding:20px; text-align:center; color:var(--text-muted)">Loading...</div>
        </div>
    </nav>

    <!-- Main Content -->
    <div id="main-wrapper">
        <header>
            <div class="header-left">
                <button id="menu-toggle" onclick="toggleSidebar()">â˜°</button>
                <div class="status-pill" id="status">Initializing...</div>
            </div>
            <button id="refreshBtn" onclick="fetchData()">Refresh Data</button>
        </header>

        <div id="content-scroll">
            <article id="content" class="markdown-body"></article>
        </div>
    </div>

    <script>
        const contentDiv = document.getElementById('content');
        const navContainer = document.getElementById('nav-container');
        const statusPill = document.getElementById('status');
        const refreshBtn = document.getElementById('refreshBtn');
        const sidebar = document.getElementById('sidebar');

        const RAW_URL = 'https://raw.githubusercontent.com/wiki/fmhy/FMHY/Stream-Site-Grading.md';

        async function fetchData() {
            refreshBtn.disabled = true;
            statusPill.textContent = "Fetching latest data...";
            statusPill.style.color = "#fbbf24"; // yellow
            contentDiv.style.opacity = '0.5';

            try {
                // 1. Fetch
                const response = await fetch(`${RAW_URL}?t=${Date.now()}`);
                if (!response.ok) throw new Error("GitHub fetch failed");
                const text = await response.text();

                // 2. Render
                contentDiv.innerHTML = marked.parse(text);

                // 3. Process
                cleanUpTableOfContents(); // Remove redundant links
                generateSidebar();        // Build the menu
                fixLinks();               // Fix external redirects

                // 4. Update Status
                const now = new Date();
                statusPill.textContent = `Updated: ${now.toLocaleTimeString()}`;
                statusPill.style.color = "#34d399"; // green

            } catch (err) {
                console.error(err);
                contentDiv.innerHTML = `<div style="text-align:center; padding:50px; color:var(--danger)">
                    <h2>Error Loading Content</h2>
                    <p>${err.message}</p>
                </div>`;
                statusPill.textContent = "Error";
                statusPill.style.color = "#f87171";
            } finally {
                refreshBtn.disabled = false;
                contentDiv.style.opacity = '1';
            }
        }

        // --- 1. SIDEBAR GENERATOR (Fixed Empty #1 Issue) ---
        function generateSidebar() {
            navContainer.innerHTML = '';
            const headers = contentDiv.querySelectorAll('h1, h2, h3');
            
            headers.forEach((header, index) => {
                // Generate a safe ID for the section
                const sectionId = `section-${index}`;
                header.id = sectionId;

                // GET TITLE TEXT
                let title = header.textContent.trim();
                
                // FIX: If title is empty (common with Logo Images in H1), find a fallback
                if (!title) {
                    const img = header.querySelector('img');
                    if (img && img.alt) title = img.alt; // Use Image Alt text
                    else if (header.tagName === 'H1') title = "Introduction"; // Fallback for top header
                    else title = `Section ${index + 1}`; // Last resort
                }

                // Create Link
                const link = document.createElement('a');
                link.textContent = title;
                link.href = `#${sectionId}`;
                link.className = 'nav-item';
                if (header.tagName === 'H3') link.classList.add('sub-item');

                link.onclick = (e) => {
                    e.preventDefault();
                    // Smooth Scroll
                    document.getElementById(sectionId).scrollIntoView({ behavior: 'smooth' });
                    // Close sidebar on mobile
                    if (window.innerWidth <= 900) toggleSidebar();
                    // Set active state
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    link.classList.add('active');
                };

                navContainer.appendChild(link);
            });
        }

        // --- 2. LINK FIXER ---
        function fixLinks() {
            contentDiv.querySelectorAll('a').forEach(link => {
                const href = link.getAttribute('href');
                if (!href) return;

                // Fix GitHub Wiki Anchor Redirects
                if (href.includes('github.com') && href.includes('#')) {
                    const anchorPart = href.split('#')[1];
                    link.removeAttribute('target');
                    link.href = '#'; 
                    link.onclick = (e) => {
                        e.preventDefault();
                        // Try to find the header text roughly matching the anchor
                        findSectionByText(anchorPart);
                    };
                } 
                // Force external links to new tab
                else if (href.startsWith('http')) {
                    link.target = "_blank";
                }
            });
        }

        // Fuzzy search to find where to scroll for broken GitHub anchors
        function findSectionByText(text) {
            const cleanText = text.toLowerCase().replace(/-/g, ' ');
            const headers = Array.from(contentDiv.querySelectorAll('h1, h2, h3'));
            const target = headers.find(h => h.textContent.toLowerCase().includes(cleanText));
            if (target) target.scrollIntoView({ behavior: 'smooth' });
        }

        // --- 3. CLEAN UP TOC ---
        function cleanUpTableOfContents() {
            // Logic: Find the "Table of Contents" Header and hide it + the list immediately following it
            const headers = contentDiv.querySelectorAll('h1, h2, h3, h4, strong'); // 'strong' sometimes used as header
            
            headers.forEach(h => {
                if (h.textContent.toLowerCase().includes('table of contents')) {
                    h.style.display = 'none'; // Hide the header
                    
                    // Find the next UL (list) and hide it
                    let nextElem = h.nextElementSibling;
                    while(nextElem) {
                        if (nextElem.tagName === 'UL') {
                            nextElem.style.display = 'none';
                            break;
                        }
                        nextElem = nextElem.nextElementSibling;
                    }
                }
            });
        }

        function toggleSidebar() {
            sidebar.classList.toggle('open');
        }

        // Init
        window.onload = fetchData;
    </script>
</body>
</html>